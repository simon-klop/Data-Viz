<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>


<!-- Load JQuey (for the double range slider that do not exist in d3.js)-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

<p>
    <label for="amount">Date range:</label>
    <input type="text" id="amount" style="border: 0; color: #f6931f; font-weight: bold;" size="100" />
</p>

<div id="slider-range"></div>


<!-- Create a div where the graph will take place -->
<div id="number_clients"></div>

<div id="my_dataviz2"></div>

<div id="my_dataviz3"></div>





<p>
    <label for="nombreBins">Nombre de bins : </label>
    <input type="number" min="1" max="300" step="10" value="20" id="nombreBins">
</p>

<!-- <script>
console.log(d3.select("#nombreBins").node().value)

console.log(document.getElementById("amount").value)
</script> -->


<script>

function drawSlider(dataset) {
    $("#slider-range").slider({
                range: true,
                min: new Date('2010 01 01').getTime() / 1000,
                max: new Date('2014 01 01').getTime() / 1000,
                step: 86400,
                values: [new Date('2011 01 01').getTime() / 1000, new Date('2013 02 01').getTime() / 1000],
                slide: function (event, ui) {
                    $("#amount").val((new Date(ui.values[0] * 1000).toDateString()) + " - " + (new Date(ui.values[1] * 1000)).toDateString());
                }
            });
            $("#amount").val((new Date($("#slider-range").slider("values", 0) * 1000).toDateString()) +
                " - " + (new Date($("#slider-range").slider("values", 1) * 1000)).toDateString());

            
    }


d3.select("#slider-range").on("mouseout", function() {
    let arr = document.getElementById("amount").value.split("-")
    console.log(arr[0])
  });

    



function BakeryViz1(dataset) {
    
    //console.log(dataset)
    console.log("hey")

    const margin = ({top: 20, right: 100, bottom: 35, left: 50})
  
    const w = 1200
    const h = 400

    const svg = d3.select("#number_clients").append("svg").attr("height", h).attr("width", w)


    const binX = d3.bin()
    const buckets1 = binX(dataset.map((d) => d.date))

    
    const x = d3.scaleTime()
        .domain([d3.min(buckets1.map(d => d.x0)),  d3.max(buckets1.map(d => d.x1))])
        .range([margin.left, w - margin.left - margin.right])
    
    svg.append("g")
       .attr("transform", `translate(0,${h - margin.bottom})`)
       .call(d3.axisBottom(x));

    // const bin = d3.bin().domain(x.domain()).thresholds(x.ticks(20));
    // const buckets_time = bin(dataset.map((d) => d.date));


    const my_map = d3.groups(dataset, d => d.ticket_number)

    //console.log(my_map.map(d => d[1].map(j => j)).map(k => k[0].date) )

    const y = d3.scaleLinear()
        .domain([0, d3.count(my_map, d => d[0])])
        .range([h-margin.bottom, margin.top])
    
    svg.append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));




    let test = [my_map.map(d => d[0]), my_map.map(d => d[1].map(j => j)).map(k => k[0].date)]
   
    let test3 = d3.intersection(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))

    //var myObject = [{ticket:my_map.map(d => d[0]), date:my_map.map(d => d[1].map(j => j)).map(k => k[0].date)}]
    
    //const myObject2 = d3.index(my_map, d => d[1].date)

    //console.log(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))


    const bin_for_tickets = d3.bin().domain(x.domain()).thresholds(x.ticks(5));
    // we keep only one date for a single ticket (before a ticket could have duplicated dates if there are several articles in it)
    const buckets_nb_tickets = bin_for_tickets(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))




     svg.selectAll("rect_clients")
         .data(buckets_nb_tickets)
         .enter()
         .append("rect") 
    //     .transition()
    //     .duration(1000)
         .attr("transform", d => "translate(" + x(d.x0) + "," + y(d.length) + ")" )
           .attr("width", d => x(d.x1) - x(d.x0) -1 )
           .attr("height", d => h - y(d.length) - margin.bottom)
           .style("fill",  "red")
          .style("opacity", 0.6)

    // axis label

        // Title
       svg.append('text')
        .attr('x',w/2 -30)
        .attr('y', 20)
        .attr('text-anchor', 'middle')
        .style('font-family', 'Helvetica')
        .style('font-size', 20)
        .text('Number of clients by time');
  
      // X label
        svg.append('text')
        .attr('x', w/2 - 30)
        .attr('y', h - margin.bottom +30)
        .attr('text-anchor', 'middle')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text('Time');
        
        // Y label
        svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('transform', 'translate(20,' + h/2 + ')rotate(-90)')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text("Number");
}






function conversor(d){
    const parseTime = d3.timeParse("%Y-%m-%d");
    d.date = parseTime(d.date)
    d.unit_price = +d.unit_price
    d.ticket_number = +d.ticket_number
    d.quantity = +d.quantity
    return d;
}

async function LoadBakeryAndDraw() {
    d3.csv(
        "https://simon-klop.github.io/Data-Viz/Bakery_clean.csv",
        conversor,
        function(data) {
            //console.log(d)
            BakeryViz1(data)
            drawSlider(data)


        })
}



LoadBakeryAndDraw()



</script>