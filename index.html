<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>


<!-- Load JQuey (for the double range slider that do not exist in d3.js)-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

<p>
    <label for="amount">Date range:</label>
    <input type="text" id="amount" style="border: 0; color: #FF0000; font-weight: bold;" size="100" />
</p>

<div id="slider-range"></div>


<!-- Create a div where the graph will take place -->
<div id="corr"></div>

<div id="my_dataviz2"></div>

<div id="my_dataviz3"></div>





<!-- <p>
    <label for="nombreBins">Nombre de bins : </label>
    <input type="number" min="1" max="300" step="10" value="20" id="nombreBins">
</p> -->

<!-- <script>
console.log(d3.select("#nombreBins").node().value)

console.log(document.getElementById("amount").value)
</script> -->


<script>






function BakeryViz1(dataset) {
    
    const margin = ({top: 35, right: 70, bottom: 35, left: 70})
    const w = 1200
    const h = 400

    var svg = d3.select("#number_clients").append("svg").attr("height", h).attr("width", w)

    // Title
    svg.append('text')
       .attr('x',w/2 -30)
       .attr('y', 20)
       .attr('text-anchor', 'middle')
       .style('font-family', 'Helvetica')
       .style('font-size', 20)
       .text('Number of clients by time');
  
      // X label
      svg.append('text')
        .attr('x', w/2 - 30)
        .attr('y', h - margin.bottom +30)
        .attr('text-anchor', 'middle')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text('Time');
        
        // Y label
        svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('transform', 'translate(20,' + h/2 + ')rotate(-90)')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text("Number");


    //console.log(my_map.map(d => d[1].map(j => j)).map(k => k[0].date) )
    //let test = [my_map.map(d => d[0]), my_map.map(d => d[1].map(j => j)).map(k => k[0].date)]
    //let test3 = d3.intersection(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))
    //var myObject = [{ticket:my_map.map(d => d[0]), date:my_map.map(d => d[1].map(j => j)).map(k => k[0].date)}]
    //const myObject2 = d3.index(my_map, d => d[1].date)
    //console.log(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))



    // X axis range init
    var x = d3.scaleTime().range([margin.left, w - margin.left - margin.right])
    var xAxis = svg.append("g").attr("transform", `translate(0,${h - margin.bottom})`)
                    //.domain([d3.min(buckets1.map(d => d.x0)),  d3.max(buckets1.map(d => d.x1))])

    // Y axis range init
    var y = d3.scaleLinear().range([h-margin.bottom, 0+margin.top])
    var yAxis = svg.append("g").attr("transform", `translate(${margin.left},0)`)



    function update(nbBins, startDate, endDate) {
        
        console.log("ici")

        var essai = d3.scaleTime().domain([startDate, endDate])

        const binX = d3.bin().domain(essai.domain()).thresholds(essai.ticks(nbBins))
        const bucketsX = binX(dataset.filter(s => s.date >= startDate && s.date <= endDate).map( d => d.date))
  
         
        x.domain([d3.min(bucketsX.map(d => d.x0)), d3.max(bucketsX.map(d => d.x1))])
        xAxis.transition()
             .duration(1000)
             .call(d3.axisBottom(x))

        // const bin = d3.bin().domain(x.domain()).thresholds(x.ticks(20));
        // const buckets_time = bin(dataset.map((d) => d.date));

        var my_map = d3.groups(dataset, d => d.ticket_number)
        var bin_for_tickets = d3.bin().domain(x.domain()).thresholds(x.ticks(nbBins));
        var buckets_nb_tickets = bin_for_tickets(my_map.map(d => d[1].map(j => j)).map(k => k[0].date))

        console.log(buckets_nb_tickets)

        // Y axis Update
        y.domain([0, d3.max(buckets_nb_tickets.map(d => d.length))])
        yAxis.transition()
             .duration(1000)
             .call(d3.axisLeft(y));



        // Join the rect with the bins data
        var current_rects = svg.selectAll("rect")
            .data(buckets_nb_tickets)

        current_rects.enter()
            .append("rect") 
            .merge(current_rects)
            .transition()
            .duration(1000)
            .attr("transform", d => "translate(" + x(d.x0) + "," + y(d.length) + ")" )
            .attr("width", d => x(d.x1) - x(d.x0) )
            .attr("height", d => h - y(d.length) - margin.bottom)
            .style("fill",  "red")
            .style("opacity", 0.6)

        // Removing rects not in use
        current_rects.exit()
            .remove()
    }


    //FIRST INIT
    let initStartDate = d3.min(dataset.map(d => d.date))
    let initEndDate = d3.max(dataset.map(d => d.date))
    update(10, initStartDate, initEndDate)

    
    //DYNAMIC
    // d3.select("#slider-range").on("click", function() {
    //     //Dates of the slider
    //     let arr = document.getElementById("amount").value.split(" - ")
    //     let parseTime = d3.timeParse("%a %b %d %Y");   
    //     let startDate = parseTime(arr[0])
    //     let endDate = parseTime(arr[1])
    //     //console.log(startDate)
    //     //console.log(endDate)
    //     update(30, startDate, endDate )
    // })


    //DYNAMIC (better with JQuery slider)
    const minDate = d3.min(dataset.map(d => d.date))
    const maxDate = d3.max(dataset.map(d => d.date))
    $("#slider-range").slider({
                range: true,
                min: new Date(minDate).getTime() / 1000,
                max: new Date(maxDate).getTime() / 1000,
                step: 86400,
                values: [new Date(minDate).getTime() / 1000, new Date(maxDate).getTime() / 1000],
                slide: function (event, ui) {
                    $("#amount").val((new Date(ui.values[0] * 1000).toDateString()) + " - " + (new Date(ui.values[1] * 1000)).toDateString());
                },
                change: function (event, ui) {
                    let arr = document.getElementById("amount").value.split(" - ")
                    let parseTime = d3.timeParse("%a %b %d %Y");   
                    let startDate = parseTime(arr[0])
                    let endDate = parseTime(arr[1])
                    update(30, startDate, endDate )
                }
            })
            
    $("#amount").val((new Date($("#slider-range").slider("values", 0) * 1000).toDateString()) +
        " - " + (new Date($("#slider-range").slider("values", 1) * 1000)).toDateString())            
    
}
    
    
    
  ///Viz Corr
    
//viewof hours = Inputs.range([8, 20], {value: 8, step: 1, label: "Quelle heure de la journée souhaitez-vous observer ?"})
    
function getFrequentItem(dataset, hours) {
   
      const sortedData = dataset.slice().sort((a, b) => d3.descending(a.article, b.article))
      const datasetByHours = d3.group(sortedData, d => d.hours)
      const datasetByHour = datasetByHours.get(hours)
      let articles = [];
      let item_count = [];
  
      // Get list of item
      d3.groups(datasetByHour, d => d.article).map(
        article => !articles.includes(article[0]) ? (articles.push(article[0])) :  console.log()
      )
      // Init
      for (let i = 0; i < articles.length; i++) {
        item_count[i] = new Array(articles.length).fill(0);
      }
  
      //get frequent item
      const article_by_client = d3.groups(datasetByHour, d => d.ticket_number)
      for (let i = 0; i < article_by_client.length; i++) {
        let tmp = []
        for (let j = 0; j < article_by_client[i][1].length; j++){
          tmp.push(article_by_client[i][1][j].article)
        }
        
        for (let item_a = 0; item_a < tmp.length; item_a++) {
          for (let item_b = 0; item_b < tmp.length; item_b++) {
            item_count[articles.indexOf(tmp[item_a])][articles.indexOf(tmp[item_b])] += 1
          }
        }
      }

      // transform in percentage
      for (let i = 0; i < articles.length; i++) {
        let divisor = item_count[i][i]
        for (let j = 0; j < articles.length; j++){
          item_count[i][j] = item_count[i][j] / divisor
        }
      }
    
      return [articles, item_count]
    };

    
function heatmap(dataset) {
  const margin = ({top: 10, right: 250, bottom: 30, left: 40})
  
  const w = 3000
  const h = 400

  const data = getFrequentItem()
  const x = data[0]
  const y = data[1]
  
  var myColor = d3.scaleLinear().domain([0.01, 1]).range(["#f4cccc", "#cc0000"])
  
  const svg = d3.create("svg").attr("height", h).attr("width", w)
  
  // rect
  for (let i = 0; i < y.length; i++) {
    for (let j = 0; j < y[i].length; j++) {
      svg.append("rect")
      .attr('x', 155 + i * 100)
      .attr('y', 67 + 30 * j)
      .attr('width', 95)
      .attr('height', 25)
      .attr('fill', function() {return myColor(y[i][j])})
      .on('mouseover', function (d, i) {
          d3.select(this).transition()
               .duration('50')
               .attr('opacity', '.80')
        
      })
      .on('mouseout', function (d, i) {
          d3.select(this).transition()
               .duration('50')
               .attr('opacity', '1')
      })
    }
  }
 
   // Axe X
  svg.append("g").selectAll("text").data(x).enter()
    .append("text")
    .attr("x", (d, i) =>  170 + i * 100)
    .attr("y", d => 40)   
    .text(d => d)
    .attr("font-size","7.5px")

  // Axe Y
  svg.append("g").selectAll("text").data(x).enter()
    .append("text")
    .attr("x", d =>  10)
    .attr("y", (d, i) => 75 + i * 30)   
    .text(d => d)
    .attr("font-size","8px")

  //legend
  svg.append("g").selectAll("text").data(d3.range(0, 1.1, 0.1)).enter()
    .append("rect")
    .attr('x', (d, i) =>  20 + 105 * i)
    .attr('y', 380)
    .attr('width', 110)
    .attr('height', 10)
    .attr('fill', function(d) {return myColor(d)})
  
  svg.append("g").selectAll("text").data(d3.range(0, 110, 10)).enter()
    .append("text")
    .attr('x', (d, i) =>  70 + 105 * i)
    .attr('y', 400)
    .text(d => d)
    .attr("font-size","10px")
  
  // Titre
  svg.append("text")
    .attr("x", 5)
    .attr("y", margin.top+5)
    .text("Frequent pattern à " + hours.toFixed(1) + " heure")
    
  return svg.node()
}
    
dataset = d3.csvParse(
  await FileAttachment("Bakery_cleaned-2.csv").text(),
  d => {
    d.tickey_number += d.tickey_number
    d.Quantity = +d.Quantity
    d.datetime = d3.timeParse("%Y-%M-%d:%H:%M")(d.date + ":" + d.time)
    d.weekday = d.datetime.getDay()
    d.hours = d.datetime.getHours()
    d.month = d.datetime.getMonth()
    return d
  }
)




function conversor(d){
    const parseTime = d3.timeParse("%Y-%m-%d");
    d.date = parseTime(d.date)
    d.unit_price = +d.unit_price
    d.ticket_number = +d.ticket_number
    d.quantity = +d.quantity
    return d;
}

async function LoadBakeryAndDraw() {
    d3.csv(
        "https://simon-klop.github.io/Data-Viz/Bakery_clean.csv",
        conversor,
        function(data) {
            BakeryViz1(data)
        })
}



LoadBakeryAndDraw()



</script>
